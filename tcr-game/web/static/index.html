<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tower Castle Rush</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            background: #1a1a1a;
            color: #ffffff;
            overflow: hidden;
        }

        .screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .screen.hidden {
            display: none;
        }

        /* Login Screen */
        .login-container {
            background: #2a2a2a;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            text-align: center;
            min-width: 300px;
        }

        .login-container h1 {
            margin-bottom: 30px;
            color: #4CAF50;
            font-size: 2.5em;
        }

        .login-form input {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border: none;
            border-radius: 5px;
            background: #3a3a3a;
            color: white;
            font-size: 16px;
        }

        .login-form button {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border: none;
            border-radius: 5px;
            background: #4CAF50;
            color: white;
            font-size: 16px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .login-form button:hover {
            background: #45a049;
        }

        .error-message {
            color: #ff4444;
            margin-top: 10px;
            min-height: 20px;
        }

        /* Game Lobby */
        .lobby-container {
            background: #2a2a2a;
            padding: 40px;
            border-radius: 10px;
            text-align: center;
            max-width: 600px;
            width: 90%;
        }

        .game-modes {
            display: flex;
            gap: 20px;
            margin: 30px 0;
            flex-wrap: wrap;
        }

        .mode-card {
            flex: 1;
            background: #3a3a3a;
            padding: 20px;
            border-radius: 8px;
            min-width: 250px;
        }

        .mode-card h3 {
            color: #4CAF50;
            margin-bottom: 10px;
        }

        .create-game-btn {
            width: 100%;
            padding: 10px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 15px;
        }

        .join-game {
            display: flex;
            gap: 10px;
            margin: 20px 0;
        }

        .join-game input {
            flex: 1;
            padding: 10px;
            background: #3a3a3a;
            border: none;
            border-radius: 5px;
            color: white;
        }

        .join-game button {
            padding: 10px 20px;
            background: #2196F3;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        .status-message {
            margin-top: 15px;
            padding: 10px;
            border-radius: 5px;
            min-height: 20px;
        }

        .status-message.success {
            background: #4CAF50;
            color: white;
        }

        .status-message.error {
            background: #f44336;
            color: white;
        }

        /* Game Screen */
        .game-container {
            width: 100%;
            height: 100vh;
            display: flex;
            flex-direction: column;
            background: #1a1a1a;
        }

        .game-header {
            display: flex;
            justify-content: space-between;
            padding: 15px 20px;
            background: #2a2a2a;
            border-bottom: 2px solid #444;
        }

        .game-info, .player-info {
            display: flex;
            gap: 20px;
        }

        .game-info span, .player-info span {
            background: #3a3a3a;
            padding: 8px 15px;
            border-radius: 5px;
            font-weight: bold;
        }

        .battlefield {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 20px;
            justify-content: space-around;
        }

        .player-area {
            text-align: center;
        }

        .player-area h3 {
            margin-bottom: 15px;
            font-size: 1.5em;
        }

        .towers {
            display: flex;
            justify-content: center;
            gap: 20px;
            flex-wrap: wrap;
        }

        .tower {
            background: #2a2a2a;
            border: 2px solid #555;
            border-radius: 10px;
            padding: 15px;
            min-width: 120px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .tower:hover {
            background: #3a3a3a;
            border-color: #777;
        }

        .tower.selected {
            border-color: #4CAF50;
            background: #2a4a2a;
            box-shadow: 0 0 15px rgba(76, 175, 80, 0.5);
        }

        .tower.king-tower {
            border-color: #ffa500;
        }

        .tower.king-tower.selected {
            border-color: #4CAF50;
            box-shadow: 0 0 15px rgba(76, 175, 80, 0.5);
        }

        .tower.destroyed {
            opacity: 0.5;
            background: #441111;
            border-color: #ff4444;
        }

        .tower-hp {
            font-weight: bold;
            font-size: 1.1em;
            color: #4CAF50;
            margin-bottom: 5px;
        }

        .tower-name {
            color: #ccc;
            font-size: 0.9em;
        }

        .troops-panel {
            background: #2a2a2a;
            padding: 20px;
            border-top: 2px solid #444;
            min-height: 150px;
        }

        .troops-panel h3 {
            margin-bottom: 15px;
            color: #4CAF50;
        }

        .troops-grid {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .troop-card {
            background: #3a3a3a;
            border: 2px solid #555;
            border-radius: 8px;
            padding: 12px;
            min-width: 140px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .troop-card:hover {
            background: #4a4a4a;
            border-color: #777;
        }

        .troop-card.selected {
            border-color: #4CAF50;
            background: #2a4a2a;
            box-shadow: 0 0 15px rgba(76, 175, 80, 0.5);
        }

        .troop-card.used {
            opacity: 0.5;
            background: #2a2a2a;
            cursor: not-allowed;
        }

        .troop-name {
            font-weight: bold;
            margin-bottom: 8px;
            color: #4CAF50;
        }

        .troop-stats {
            font-size: 0.9em;
            color: #ccc;
            line-height: 1.4;
        }

        .troop-mana {
            color: #2196F3;
            font-weight: bold;
        }

        .game-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
            padding: 0 20px 20px;
        }

        .action-btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            min-width: 150px;
        }

        #attack-btn {
            background: #f44336;
            color: white;
        }

        #attack-btn:not(:disabled):hover {
            background: #da190b;
            transform: translateY(-2px);
        }

        #attack-btn:disabled {
            background: #555;
            color: #999;
            cursor: not-allowed;
        }

        #end-turn-btn {
            background: #2196F3;
            color: white;
        }

        #end-turn-btn:not(:disabled):hover {
            background: #1976d2;
            transform: translateY(-2px);
        }

        #end-turn-btn:disabled {
            background: #555;
            color: #999;
            cursor: not-allowed;
        }

        .battle-log {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #2a2a2a;
            border: 2px solid #444;
            border-radius: 10px;
            padding: 15px;
            max-width: 300px;
            max-height: 200px;
            overflow-y: auto;
        }

        .battle-log h4 {
            color: #4CAF50;
            margin-bottom: 10px;
            border-bottom: 1px solid #444;
            padding-bottom: 5px;
        }

        .log-entry {
            padding: 3px 0;
            font-size: 0.9em;
            color: #ccc;
        }

        .log-entry.crit {
            color: #ffa500;
            font-weight: bold;
        }

        .log-entry.damage {
            color: #ff6666;
        }

        .log-entry.tower-destroyed {
            color: #ff4444;
            font-weight: bold;
        }

        .log-entry.error {
            color: #ff4444;
        }

        /* Game Over */
        .game-over-container {
            background: #2a2a2a;
            padding: 40px;
            border-radius: 10px;
            text-align: center;
            max-width: 400px;
        }

        #game-result {
            font-size: 3em;
            margin-bottom: 20px;
        }

        #game-result.winner {
            color: #4CAF50;
        }

        #game-result.loser {
            color: #f44336;
        }

        #game-result.draw {
            color: #ff9800;
        }

        #new-game-btn {
            padding: 12px 25px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }

        /* Loading indicator */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #4CAF50;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .game-header {
                flex-direction: column;
                gap: 10px;
            }

            .game-info, .player-info {
                flex-direction: column;
                gap: 5px;
            }

            .towers {
                gap: 10px;
            }

            .tower {
                min-width: 100px;
                padding: 10px;
            }

            .battle-log {
                position: relative;
                margin: 20px;
                max-width: none;
            }

            .game-actions {
                flex-direction: column;
                align-items: center;
            }

            .action-btn {
                width: 90%;
                max-width: 250px;
            }
        }
    </style>
</head>
<body>
    <div id="app">
        <div id="login-screen" class="screen">
            <div class="login-container">
                <h1>Tower Castle Rush</h1>
                <div class="login-form">
                    <input type="text" id="username" placeholder="Username" required>
                    <input type="password" id="password" placeholder="Password" required>
                    <button id="login-btn">Login</button>
                    <button id="register-btn">Register</button>
                </div>
                <div id="login-error" class="error-message"></div>
            </div>
        </div>

        <div id="game-lobby" class="screen hidden">
            <div class="lobby-container">
                <h2>Game Lobby</h2>
                <div class="game-modes">
                    <div class="mode-card">
                        <h3>Simple Mode</h3>
                        <p>Turn-based gameplay with 3 random troops</p>
                        <button id="create-simple-btn" class="create-game-btn">Create Game</button>
                    </div>
                    <div class="mode-card">
                        <h3>Enhanced Mode</h3>
                        <p>Real-time 3-minute battles with mana system</p>
                        <button id="create-enhanced-btn" class="create-game-btn">Create Game</button>
                    </div>
                </div>
                <div class="join-game">
                    <input type="text" id="game-id-input" placeholder="Game ID">
                    <button id="join-game-btn">Join Game</button>
                </div>
                <div id="lobby-status" class="status-message"></div>
            </div>
        </div>

        <div id="game-screen" class="screen hidden">
            <div class="game-container">
                <div class="game-header">
                    <div class="game-info">
                        <span id="game-mode">Mode: Simple</span>
                        <span id="game-time">Time: --:--</span>
                    </div>
                    <div class="player-info">
                        <span id="current-turn">Turn: Player 1</span>
                        <span id="player-mana">Mana: 5/10</span>
                        <span id="user-timeout">Timeout: <span id="timeout-counter">30</span>s</span>
                    </div>
                </div>

                <div class="battlefield">
                    <div class="player-area" id="opponent-area">
                        <h3 id="opponent-name">Opponent</h3>
                        <div class="towers">
                            <div class="tower" id="opp-tower-0" data-tower="0">
                                <div class="tower-hp">300/300</div>
                                <div class="tower-name">Guard Tower L</div>
                            </div>
                            <div class="tower" id="opp-tower-1" data-tower="1">
                                <div class="tower-hp">300/300</div>
                                <div class="tower-name">Guard Tower R</div>
                            </div>
                            <div class="tower king-tower" id="opp-tower-2" data-tower="2">
                                <div class="tower-hp">500/500</div>
                                <div class="tower-name">King Tower</div>
                            </div>
                        </div>
                    </div>

                    <div class="player-area" id="player-area">
                        <h3 id="player-name">You</h3>
                        <div class="towers">
                            <div class="tower" id="player-tower-0" data-tower="0">
                                <div class="tower-hp">300/300</div>
                                <div class="tower-name">Guard Tower L</div>
                            </div>
                            <div class="tower" id="player-tower-1" data-tower="1">
                                <div class="tower-hp">300/300</div>
                                <div class="tower-name">Guard Tower R</div>
                            </div>
                            <div class="tower king-tower" id="player-tower-2" data-tower="2">
                                <div class="tower-hp">500/500</div>
                                <div class="tower-name">King Tower</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="troops-panel">
                    <h3>Your Troops <span id="troops-loading" class="loading hidden"></span></h3>
                    <div id="troops-list" class="troops-grid">
                        <!-- Troops will be loaded dynamically from the database -->
                    </div>
                </div>

                <div class="game-actions">
                    <button id="attack-btn" class="action-btn" disabled>Select troop and target</button>
                    <button id="end-turn-btn" class="action-btn">End Turn</button>
                </div>

                <div id="battle-log" class="battle-log">
                    <h4>Battle Log</h4>
                    <div id="log-content">
                        <div class="log-entry">Game started!</div>
                    </div>
                </div>
            </div>
        </div>

        <div id="game-over" class="screen hidden">
            <div class="game-over-container">
                <h2 id="game-result">Game Over</h2>
                <div id="game-stats"></div>
                <button id="new-game-btn">New Game</button>
            </div>
        </div>
    </div>

    <script>
        class TCRGame {
            constructor() {
                this.wsConnection = null;
                this.token = null;
                this.gameId = null;
                this.playerId = null;
                this.selectedTroop = null;
                this.selectedTower = null;
                this.gameState = null;
                this.turnTimeoutId = null;
                this.turnTimeLeft = 30; // 30 seconds per turn
                this.turnTimerInterval = null;
                
                this.initEventListeners();
                this.showScreen('game-screen'); // Skip to game screen for testing
                this.loadTroopsFromDatabase();
            }

            // NEW: Load troops dynamically from database
            async loadTroopsFromDatabase() {
                try {
                    // Show loading indicator
                    document.getElementById('troops-loading').classList.remove('hidden');
                    
                    // In a real implementation, this would call your backend API
                    // For demo purposes, we're simulating an API call
                    const response = await this.simulateDatabaseCall();
                    
                    // Clear existing hardcoded troops
                    const troopsContainer = document.getElementById('troops-list');
                    troopsContainer.innerHTML = '';
                    
                    // Dynamically create troop cards from database data
                    response.forEach(troop => {
                        this.createTroopCard(troop, troopsContainer);
                    });
                    
                    // Hide loading indicator
                    document.getElementById('troops-loading').classList.add('hidden');
                    
                    console.log('Troops loaded successfully from database');
                } catch (error) {
                    console.error('Failed to load troops:', error);
                    this.addLogEntry('Failed to load troops from database', 'error');
                    document.getElementById('troops-loading').classList.add('hidden');
                }
            }

            // Simulate database call - replace with actual API call
            async simulateDatabaseCall() {
                return new Promise((resolve) => {
                    setTimeout(() => {
                        resolve([
                            {
                                "id": "goblin",
                                "name": "Goblin",
                                "hp": 100,
                                "attack": 30,
                                "defense": 5,
                                "crit_chance": 0.1,
                                "mana_cost": 2,
                                "description": "Fast and cheap melee unit"
                            },
                            {
                                "id": "archer",
                                "name": "Archer",
                                "hp": 80,
                                "attack": 40,
                                "defense": 3,
                                "crit_chance": 0.15,
                                "mana_cost": 3,
                                "description": "Ranged unit with good damage"
                            },
                            {
                                "id": "knight",
                                "name": "Knight",
                                "hp": 150,
                                "attack": 35,
                                "defense": 10,
                                "crit_chance": 0.05,
                                "mana_cost": 4,
                                "description": "Heavily armored melee unit"
                            },
                            {
                                "id": "wizard",
                                "name": "Wizard",
                                "hp": 70,
                                "attack": 50,
                                "defense": 2,
                                "crit_chance": 0.2,
                                "mana_cost": 5,
                                "description": "High damage magical attacker"
                            },
                            {
                                "id": "dragon",
                                "name": "Dragon",
                                "hp": 200,
                                "attack": 60,
                                "defense": 8,
                                "crit_chance": 0.25,
                                "mana_cost": 8,
                                "description": "Powerful flying unit"
                            }
                        ]);
                    }, 1000); // Simulate network delay
                });
            }

            // NEW: Create troop card dynamically
            createTroopCard(troop, container) {
                const troopCard = document.createElement('div');
                troopCard.className = 'troop-card';
                troopCard.dataset.troopId = troop.id;
                
                troopCard.innerHTML = `
                    <div class="troop-name">${troop.name}</div>
                    <div class="troop-stats">
                        HP: ${troop.hp}/${troop.hp}<br>
                        ATK: ${troop.attack} DEF: ${troop.defense}<br>
                        <span class="troop-mana">Mana: ${troop.mana_cost}</span><br>
                        <small>${troop.description}</small>
                    </div>
                `;
                
                container.appendChild(troopCard);
                
                // Add click event listener
                troopCard.addEventListener('click', () => {
                    if (!troopCard.classList.contains('used')) {
                        this.selectTroop(troop.id);
                    }
                });
            }

            // NEW: User timeout system
            startTurnTimer() {
                this.turnTimeLeft = 30; // Reset to 30 seconds
                this.updateTimeoutDisplay();
                
                // Clear any existing timer
                if (this.turnTimerInterval) {
                    clearInterval(this.turnTimerInterval);
                }
                
                // Start countdown
                this.turnTimerInterval = setInterval(() => {
                    this.turnTimeLeft--;
                    this.updateTimeoutDisplay();
                    
                    // Warn user when time is running out
                    if (this.turnTimeLeft === 10) {
                        this.addLogEntry('Warning: 10 seconds remaining!', 'error');
                    }
                    
                    // Auto-end turn when time runs out
                    if (this.turnTimeLeft <= 0) {
                        this.handleTurnTimeout();
                    }
                }, 1000);
            }

            updateTimeoutDisplay() {
                const timeoutElement = document.getElementById('timeout-counter');
                if (timeoutElement) {
                    timeoutElement.textContent = this.turnTimeLeft;
                    
                    // Change color as time runs out
                    if (this.turnTimeLeft <= 10) {
                        timeoutElement.style.color = '#ff4444';
                    } else if (this.turnTimeLeft <= 20) {
                        timeoutElement.style.color = '#ffa500';
                    } else {
                        timeoutElement.style.color = '#ffffff';
                    }
                }
            }

            handleTurnTimeout() {
                this.addLogEntry('Turn timed out! Auto-ending turn...', 'error');
                this.clearSelections();
                this.endTurn();
            }

            stopTurnTimer() {
                if (this.turnTimerInterval) {
                    clearInterval(this.turnTimerInterval);
                    this.turnTimerInterval = null;
                }
            }

            // Modified endTurn method to include timer management
            endTurn() {
                this.stopTurnTimer();
                
                if (this.gameState && this.gameState.current_player && this.gameState.current_player.id === this.playerId) {
                    // Switch turns
                    this.gameState.current_player = this.gameState.players.find(p => p.id !== this.playerId);
                    this.updateGameState(this.gameState);
                    this.addLogEntry('Turn ended');
                    console.log('Turn ended');
                }
            }

            // Modified updateGameState to start timer for player's turn
            updateGameState(gameState) {
                this.gameState = gameState;
                
                // Stop any existing timer
                this.stopTurnTimer();
                
                // Update game info
                document.getElementById('game-mode').textContent = `Mode: ${gameState.mode}`;
                
                // Update players
                if (gameState.players && gameState.players.length >= 2) {
                    const player = gameState.players.find(p => p.id === this.playerId);
                    const opponent = gameState.players.find(p => p.id !== this.playerId);
                    
                    if (player && opponent) {
                        document.getElementById('player-name').textContent = `You (${player.username})`;
                        document.getElementById('opponent-name').textContent = opponent.username;
                        
                        this.updateTowers(player.towers, 'player');
                        this.updateTowers(opponent.towers, 'opp');
                        this.updateTroops(player.troops);
                        
                        if (gameState.current_player) {
                            const isMyTurn = gameState.current_player.id === this.playerId;
                            document.getElementById('current-turn').textContent = 
                                `Turn: ${isMyTurn ? 'Your Turn' : gameState.current_player.username}`;
                            
                            // Enable/disable buttons based on turn
                            const attackBtn = document.getElementById('attack-btn');
                            const endTurnBtn = document.getElementById('end-turn-btn');
                            
                            if (!isMyTurn) {
                                attackBtn.disabled = true;
                                endTurnBtn.disabled = true;
                                attackBtn.textContent = "Wait for your turn";
                            } else {
                                endTurnBtn.disabled = false;
                                this.updateAttackButton();
                                // Start timer for player's turn
                                this.startTurnTimer();
                            }
                        }
                    }
                }
            }

            initEventListeners() {
                // Login/Register
                document.getElementById('login-btn').addEventListener('click', () => this.login());
                document.getElementById('register-btn').addEventListener('click', () => this.register());
                
                // Lobby events
                document.getElementById('create-simple-btn').addEventListener('click', () => this.createGame('simple'));
                document.getElementById('create-enhanced-btn').addEventListener('click', () => this.createGame('enhanced'));
                document.getElementById('join-game-btn').addEventListener('click', () => this.joinGame());
                
                // Game actions
                document.getElementById('attack-btn').addEventListener('click', () => this.attack());
                document.getElementById('end-turn-btn').addEventListener('click', () => this.endTurn());
                document.getElementById('new-game-btn').addEventListener('click', () => this.newGame());
                
                // Enter key for login
                document.getElementById('password').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.login();
                });
                
                // Enter key for join game
                document.getElementById('game-id-input').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.joinGame();
                });

                // Add tower click events for all opponent towers
                for (let i = 0; i < 3; i++) {
                    const tower = document.getElementById(`opp-tower-${i}`);
                    if (tower) {
                        tower.addEventListener('click', () => this.selectTower(i));
                    }
                }
            }

            showScreen(screenId) {
                document.querySelectorAll('.screen').forEach(screen => {
                    screen.classList.add('hidden');
                });
                document.getElementById(screenId).classList.remove('hidden');
            }

            showError(elementId, message) {
                document.getElementById(elementId).textContent = message;
                setTimeout(() => {
                    document.getElementById(elementId).textContent = '';
                }, 5000);
            }

            showStatus(message, type = 'info') {
                const statusEl = document.getElementById('lobby-status');
                statusEl.textContent = message;
                statusEl.className = `status-message ${type}`;
                setTimeout(() => {
                    statusEl.textContent = '';
                    statusEl.className = 'status-message';
                }, 5000);
            }

            async login() {
                // Demo login - skip to lobby
                this.showScreen('game-lobby');
                console.log('Demo login - moved to lobby');
            }

            async register() {
                this.showStatus('Demo mode - registration would work here', 'success');
            }

            async createGame(mode) {
                this.gameId = `demo_${mode}_${Date.now()}`;
                this.showScreen('game-screen');
                this.showStatus(`Demo game created: ${this.gameId}`, 'success');
                console.log('Demo game created:', mode);
                
                // Initialize demo game state with current player
                this.playerId = 'player1';
                this.gameState = {
                    mode: mode,
                    current_player: { id: 'player1' },
                    players: [
                        {
                            id: 'player1',
                            username: 'You',
                            towers: [
                                { hp: 300, max_hp: 300, alive: true },
                                { hp: 300, max_hp: 300, alive: true },
                                { hp: 500, max_hp: 500, alive: true }
                            ]
                        },
                        {
                            id: 'player2',
                            username: 'Opponent',
                            towers: [
                                { hp: 300, max_hp: 300, alive: true },
                                { hp: 300, max_hp: 300, alive: true },
                                { hp: 500, max_hp: 500, alive: true }
                            ]
                        }
                    ]
                };
                this.updateGameState(this.gameState);
                // Load troops after game is created
                await this.loadTroopsFromDatabase();
            }

            async joinGame() {
                const gameId = document.getElementById('game-id-input').value.trim();
                if (!gameId) {
                    this.showStatus('Please enter a game ID', 'error');
                    return;
                }
                this.gameId = gameId;
                this.showScreen('game-screen');
                console.log('Demo join game:', gameId);
                
                // Initialize demo game state for joined player
                this.playerId = 'player2';
                this.gameState = {
                    mode: 'simple',
                    current_player: { id: 'player1' },
                    players: [
                        {
                            id: 'player1',
                            username: 'Opponent',
                            towers: [
                                { hp: 300, max_hp: 300, alive: true },
                                { hp: 300, max_hp: 300, alive: true },
                                { hp: 500, max_hp: 500, alive: true }
                            ]
                        },
                        {
                            id: 'player2',
                            username: 'You',
                            towers: [
                                { hp: 300, max_hp: 300, alive: true },
                                { hp: 300, max_hp: 300, alive: true },
                                { hp: 500, max_hp: 500, alive: true }
                            ]
                        }
                    ]
                };
                this.updateGameState(this.gameState);
                // Load troops after joining game
                await this.loadTroopsFromDatabase();
            }

            updateTowers(towers, prefix) {
                towers.forEach((tower, index) => {
                    const towerEl = document.getElementById(`${prefix}-tower-${index}`);
                    if (towerEl) {
                        const hpEl = towerEl.querySelector('.tower-hp');
                        if (hpEl) {
                            hpEl.textContent = `${tower.hp}/${tower.max_hp}`;
                        }
                        
                        if (!tower.alive) {
                            towerEl.classList.add('destroyed');
                        }
                    }
                });
            }

            updateTroops(troops) {
                // This updates the existing troop cards rather than recreating them
                if (!troops) return;
                
                troops.forEach(troop => {
                    const troopCard = document.querySelector(`[data-troop-id="${troop.id}"]`);
                    if (troopCard) {
                        const statsEl = troopCard.querySelector('.troop-stats');
                        if (statsEl) {
                            statsEl.innerHTML = `
                                HP: ${troop.hp}/${troop.max_hp}<br>
                                ATK: ${troop.attack} DEF: ${troop.defense}
                                ${troop.mana_cost ? `<br><span class="troop-mana">Mana: ${troop.mana_cost}</span>` : ''}
                            `;
                        }
                        
                        if (!troop.alive && troop.alive !== undefined) {
                            troopCard.classList.add('used');
                        }
                    }
                });
            }

            selectTroop(troopId) {
                // Remove previous selection
                document.querySelectorAll('.troop-card').forEach(card => {
                    card.classList.remove('selected');
                });
                
                // Select new troop
                const troopCard = document.querySelector(`[data-troop-id="${troopId}"]`);
                if (troopCard && !troopCard.classList.contains('used')) {
                    troopCard.classList.add('selected');
                    this.selectedTroop = troopId;
                    console.log('Selected troop:', troopId);
                }
                
                this.updateAttackButton();
            }

            selectTower(towerIndex) {
                // Remove previous selection
                document.querySelectorAll('.tower').forEach(tower => {
                    tower.classList.remove('selected');
                });
                
                // Select new tower
                const towerEl = document.getElementById(`opp-tower-${towerIndex}`);
                if (towerEl && !towerEl.classList.contains('destroyed')) {
                    towerEl.classList.add('selected');
                    this.selectedTower = towerIndex;
                    console.log('Selected tower:', towerIndex);
                }
                
                this.updateAttackButton();
            }

            updateAttackButton() {
                const attackBtn = document.getElementById('attack-btn');
                
                // Check if it's player's turn
                if (this.gameState && this.gameState.current_player && this.gameState.current_player.id !== this.playerId) {
                    attackBtn.disabled = true;
                    attackBtn.textContent = "Wait for your turn";
                    return;
                }
                
                const canAttack = this.selectedTroop && this.selectedTower !== null;
                attackBtn.disabled = !canAttack;
                
                if (canAttack) {
                    const troopCard = document.querySelector(`[data-troop-id="${this.selectedTroop}"]`);
                    const troopName = troopCard ? troopCard.querySelector('.troop-name').textContent : this.selectedTroop;
                    attackBtn.textContent = `Attack with ${troopName}`;
                } else {
                    attackBtn.textContent = 'Select troop and target';
                }
            }

            attack() {
                if (!this.selectedTroop || this.selectedTower === null) {
                    console.log('Cannot attack: missing troop or tower selection');
                    return;
                }
                
                // Check if it's player's turn
                if (this.gameState && this.gameState.current_player && this.gameState.current_player.id !== this.playerId) {
                    this.addLogEntry('Not your turn!', 'error');
                    return;
                }
                
                console.log(`Attacking tower ${this.selectedTower} with troop ${this.selectedTroop}`);
                
                // Demo attack logic
                const troopCard = document.querySelector(`[data-troop-id="${this.selectedTroop}"]`);
                const troopName = troopCard ? troopCard.querySelector('.troop-name').textContent : this.selectedTroop;
                const towerEl = document.getElementById(`opp-tower-${this.selectedTower}`);
                const towerName = towerEl ? towerEl.querySelector('.tower-name').textContent : `Tower ${this.selectedTower}`;
                
                // Simulate damage
                const damage = Math.floor(Math.random() * 50) + 25;
                const isCrit = Math.random() < 0.2;
                const actualDamage = isCrit ? Math.floor(damage * 1.5) : damage;
                
                // Update tower HP
                if (this.gameState && this.gameState.players) {
                    const opponent = this.gameState.players.find(p => p.id !== this.playerId);
                    if (opponent && opponent.towers[this.selectedTower]) {
                        opponent.towers[this.selectedTower].hp = Math.max(0, opponent.towers[this.selectedTower].hp - actualDamage);
                        this.updateTowers(opponent.towers, 'opp');
                        
                        let logText = `${troopName} attacks ${towerName} for ${actualDamage} damage`;
                        if (isCrit) logText += ' (CRITICAL HIT!)';
                        
                        if (opponent.towers[this.selectedTower].hp <= 0) {
                            opponent.towers[this.selectedTower].alive = false;
                            towerEl.classList.add('destroyed');
                            logText += ' - Tower destroyed!';
                            this.addLogEntry(logText, 'tower-destroyed');
                        } else {
                            this.addLogEntry(logText, isCrit ? 'crit' : 'damage');
                        }
                        
                        // Mark troop as used
                        const player = this.gameState.players.find(p => p.id === this.playerId);
                        if (player && player.troops) {
                            const troop = player.troops.find(t => t.id === this.selectedTroop);
                            if (troop) {
                                troop.alive = false;
                                troopCard.classList.add('used');
                            }
                        }
                        
                        // Switch turns
                        this.gameState.current_player = this.gameState.players.find(p => p.id !== this.playerId);
                        this.updateGameState(this.gameState);
                    }
                }
                
                // Clear selections
                this.clearSelections();
            }

            clearSelections() {
                this.selectedTroop = null;
                this.selectedTower = null;
                document.querySelectorAll('.selected').forEach(el => {
                    el.classList.remove('selected');
                });
                this.updateAttackButton();
            }

            addLogEntry(text, type = '') {
                const logContent = document.getElementById('log-content');
                const entry = document.createElement('div');
                entry.className = `log-entry ${type}`;
                entry.textContent = text;
                logContent.appendChild(entry);
                logContent.scrollTop = logContent.scrollHeight;
                
                // Keep log size manageable
                if (logContent.children.length > 20) {
                    logContent.removeChild(logContent.firstChild);
                }
            }

            handleGameEnd(message) {
                // Stop any running timers when game ends
                this.stopTurnTimer();
                
                const resultEl = document.getElementById('game-result');
                const statsEl = document.getElementById('game-stats');
                
                if (message.winner === this.playerId) {
                    resultEl.textContent = 'Victory!';
                    resultEl.className = 'winner';
                } else if (message.winner) {
                    resultEl.textContent = 'Defeat!';
                    resultEl.className = 'loser';
                } else {
                    resultEl.textContent = 'Draw!';
                    resultEl.className = 'draw';
                }
                
                statsEl.innerHTML = `Reason: ${message.reason}`;
                this.showScreen('game-over');
            }

            newGame() {
                // Stop timers
                this.stopTurnTimer();
                
                this.gameId = null;
                this.selectedTroop = null;
                this.selectedTower = null;
                this.gameState = null;
                
                // Clear any visual selections
                document.querySelectorAll('.selected').forEach(el => {
                    el.classList.remove('selected');
                });
                document.querySelectorAll('.used').forEach(el => {
                    el.classList.remove('used');
                });
                document.querySelectorAll('.destroyed').forEach(el => {
                    el.classList.remove('destroyed');
                });
                
                // Clear troops container to reload fresh ones
                document.getElementById('troops-list').innerHTML = '';
                
                this.showScreen('game-lobby');
                console.log('New game - returned to lobby');
            }
        }

        // Initialize game when page loads
        document.addEventListener('DOMContentLoaded', () => {
            window.game = new TCRGame();
            console.log('Game initialized with dynamic troops and timeout system');
        });
